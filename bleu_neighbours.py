# -*- coding: utf-8 -*-
"""BLEU_neighbours.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1DMDIXRc-fGHNJxKP1RR8i5KJ9Z9oJBm0
"""
import os
os.system('pip install pandas')
os.system('pip install nltk')
import pandas as pd
import nltk

def bleu_score(a,b):

  ref_sent=a
  hyp_sent=b
  ref_sent_list=[item.split(' ') for item in ref_sent[0:len(ref_sent)]]
  hyp_sent_list=[item.split(' ') for item in hyp_sent[0:len(hyp_sent)]]
  ref_merged=[]
  hyp_merged=[]
  for l in ref_sent_list:
    ref_merged+=l
  for l in hyp_sent_list:
    hyp_merged+=l
  ref_sent = [ref_merged]
  l_ref=[ref_sent]
  l_hyp=[hyp_merged]
  corp_score= nltk.translate.bleu_score.corpus_bleu(l_ref, l_hyp,weights=(0,0.33,0.33,0.33))
  return corp_score

def train_summary_data():
  doc=pd.read_csv('./bleu_n_data/summarization_round2_sum09_spliced.csv')
  record={}             # SUMMARY ROUND-2 SUM 09
  for i in range(0,25):
    sent_row=doc['Input.OUT'+ str(i)]
    ans_row=doc['Answer.'+str(i)]
    count=0
    for j in range(0,160,20):
      score=0
      for k in range(0,20):
        if (ans_row[count]=='Invalid'):
          score += 0
        elif (ans_row[count]=='Rare'):
          score += 0.2
        elif (ans_row[count]=='Specific'):
          score += 0.4
        elif (ans_row[count]=='Average'):
          score += 0.6
        elif (ans_row[count] == 'Typical'):
          score += 0.8
        elif (ans_row[count] == 'Very Typical'):
          score += 1
        count += 1
      score=(score/20)
      record[sent_row[j]]=score
      score=0
  return record

def summary_score():
  record = train_summary_data()
  test_summary=input('Enter the test summary : ')
  count = 0
  score= 0
  for key in record:
    if (bleu_score(key,test_summary) > 0.08) :
      
      count += 1
      score += record[key]
  if (count > 5) and (count < int(0.66*len(record))):
    print(score/count)
  else :
    print('Not defined.')

def train_sent_data():
  sent=pd.read_csv('./bleu_n_data/lm_results.csv')
  record_sent={}             # SUMMARY ROUND-2 SUM 09
  for i in range(0,25):
    sent_row=sent['Input.OUT'+ str(i)]
    ans_row=sent['Answer.'+str(i)]
    count=0
    for j in range(0,160,20):
      score=0
      for k in range(0,20):
        if (ans_row[count]=='Invalid'):
          score += 0
        elif (ans_row[count]=='Rare'):
          score += 0.2
        elif (ans_row[count]=='Specific'):
          score += 0.4
        elif (ans_row[count]=='Average'):
          score += 0.6
        elif (ans_row[count] == 'Typical'):
          score += 0.8
        elif (ans_row[count] == 'Very Typical'):
          score += 1
        count += 1
      score=(score/20)
      record_sent[sent_row[j]]=score
      score=0
  return record_sent

def sent_score():
  record_sent = train_sent_data()
  test_sentence=input('Enter the sentence')
  count = 0
  score= 0
  for key in record_sent:
    if (bleu_score(key,test_sentence) > 0.08) :
      
      count += 1
      score += record_sent[key]
  if (count > 5) and (count < int(0.66*len(record_sent))):
    print(score/count)
  else :
    print('Not defined.')

if __name__=='__main__':
  print('Enter what you want to evaluate through BLEU_neighbours : ')
  print('Press 1 for summary evaluation')
  print('Press 2 for sentence evaluation')
  choice=int(input())
  if choice == 1:
    summary_score()
  elif choice == 2:
    sent_score()

